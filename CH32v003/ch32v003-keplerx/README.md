Kepler X 参號機への書き込み方法


# Step 1 接続

PC(Mac)と Kepler X 参號機を WCH-LinkE ケーブルで接続します。GNDとSWDIOの2本のみで接続可能です。

* GND→Kepler X 参號機の J14の GND
* SWDIO→Kepler X 参號機の J14の SWIO

# Step 2 電源投入

Kepler Xの電源は、以下のいずれかの方法で投入可能です。

* FPGAボードの Mini-USB端子から供給する
    * 参號機の場合は、Kepler Xのボード上の J13をショートすると、FPGAボードから Kepler X側に+5Vができるようになっており、机上での電源供給が可能で便利です。
    * 量産時はこれを使います。
* X68000本体に接続する
    * 本体に接続すれば当然 Kepler Xに電源が供給されるのですが、ボードが本体に内蔵されてしまうため、WCH-LinkEケーブルを接続するのが少し面倒です。
* Keple Xの 5V端子から供給する
    * ボード上の +5V IN端子に接続することで、外部から電源供給することができますが、半田付けが必要になるため量産時には使えません。

# Step 3 モード変更

```
# minichlink -D
```

これをすると PD7 (Port Dの 7番)が NRST(リセット)端子ではなく、GPIOとして使えるようになります。

**実施しないとSDカードのアクセスができない(バスバッファがハイインピーダンスのままになる)ので注意が必要です。**

**オプションは必ず大文字のDにしてください。** 小文字の `-d` は逆の意味(PD7をNRSTとして使う)というオプションです。
詳しくは、

```
# minichlink -h
```

でヘルプを見てください。

# Step 4 書き込み

VS Codeで Platform IO を起動し、 `main_keplerx.c` のコンパイル結果をCH32V003にアップロードします。

アップロード後、LEDの点灯や、SDカードの挿抜で音が鳴るか、SDカードアクセスができるかなどを確認します。